<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Cammino Santa Barbara - Planner ARST</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; background: #f4f4f4; }
        #map { flex: 3; height: 100%; }
        #sidebar { flex: 1; padding: 20px; background: #fff; overflow-y: auto; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .tappa-item { padding: 12px; border: 1px solid #ddd; margin-bottom: 8px; cursor: pointer; border-radius: 6px; font-size: 0.9rem; }
        .selezionata { background-color: #e8f4f8; border-color: #007bff; border-left: 6px solid #007bff; font-weight: bold;}
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 8px; margin-top: 10px;}
        .info-bus { background: #fff9c4; padding: 8px; margin-top: 5px; border-radius: 4px; font-size: 0.8rem; border-left: 3px solid #fbc02d; }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="sidebar">
        <h2>Il mio Cammino ðŸ¥¾</h2>
        <p>Seleziona le tappe. Se mancano collegamenti, userÃ² i dati dei PDF ARST caricati.</p>
        <div id="lista-tappe">Caricamento tracce...</div>
        <button onclick="generaPDF()">Genera PDF Itinerario</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Database estratto dai PDF caricati
        const arstDb = [
            { id: "840", from: ["iglesias", "domusnovas"], to: ["masua"], file: "840.pdf" },
            { id: "853", from: ["funtanamare"], to: ["iglesias"], file: "853.pdf" },
            { id: "847", from: ["portoscuso", "nuraxi figus"], to: ["gonnesa", "iglesias"], file: "847.pdf" },
            { id: "841", from: ["iglesias", "villacidro"], to: ["guspini"], file: "841.pdf" },
            { id: "8005", from: ["carbonia"], to: ["iglesias"], file: "8005.pdf" },
            { id: "855", from: ["plage mesu"], to: ["iglesias"], file: "855.pdf" },
            { id: "856", from: ["plage mesu"], to: ["domusnovas"], file: "856.pdf" },
            { id: "8002", from: ["iglesias", "carbonia"], to: ["decimomannu"], file: "8002.pdf" }
        ];

        const map = L.map('map').setView([39.2238, 8.5204], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let tappeSelezionate = [];
        let datiGPX = {}; 
        const repoUser = "palmasstudio-collab";
        const repoName = "GPX-tracker";

        fetch(`https://api.github.com/repos/${repoUser}/${repoName}/contents/gpx`)
            .then(r => r.json()).then(files => {
                const list = document.getElementById('lista-tappe');
                list.innerHTML = '';
                files.filter(f => f.name.endsWith('.gpx')).forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'tappa-item';
                    div.innerText = file.name.replace('.gpx', '').replace(/-/g, ' ');
                    div.onclick = () => toggleTappa(div, file.name);
                    list.appendChild(div);

                    new L.GPX(file.download_url, {
                        async: true,
                        polyline_options: { color: '#888', opacity: 0.6, weight: 3 }
                    }).on('loaded', e => {
                        datiGPX[file.name] = { distanza: (e.target.get_distance() / 1000).toFixed(2), layer: e.target };
                    }).addTo(map);
                });
            });

        function toggleTappa(div, name) {
            const idx = tappeSelezionate.indexOf(name);
            if(idx > -1) {
                tappeSelezionate.splice(idx, 1);
                div.classList.remove('selezionata');
                datiGPX[name].layer.setStyle({color:'#888'});
            } else {
                tappeSelezionate.push(name);
                div.classList.add('selezionata');
                datiGPX[name].layer.setStyle({color:'#007bff', weight:5});
            }
        }

        function trovaInfoBus(current, next) {
            const c = current.toLowerCase();
            const n = next.toLowerCase();
            return arstDb.find(bus => 
                (bus.from.some(f => c.includes(f)) && bus.to.some(t => n.includes(t))) ||
                (bus.from.some(f => n.includes(f)) && bus.to.some(t => c.includes(t)))
            );
        }

        function generaPDF() {
            if(tappeSelezionate.length === 0) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;

            doc.setFontSize(18).text("Programma Cammino di Santa Barbara", 10, y);
            y += 15;

            tappeSelezionate.forEach((nome, i) => {
                const d = datiGPX[nome];
                doc.setFontSize(12).setFont(undefined, 'bold').text(`Tappa ${i+1}: ${nome.replace('.gpx','')}`, 10, y);
                y += 7;
                doc.setFont(undefined, 'normal').text(`Distanza stimata a piedi: ${d.distanza} km`, 10, y);
                y += 10;

                if(i < tappeSelezionate.length - 1) {
                    const bus = trovaInfoBus(nome, tappeSelezionate[i+1]);
                    if(bus) {
                        doc.setTextColor(0, 100, 0).setFont(undefined, 'italic');
                        doc.text(`-> Collegamento ARST Linea ${bus.id}`, 15, y);
                        y += 6;
                        doc.setFontSize(9).setTextColor(100);
                        doc.text(`Consulta orario: https://${repoUser}.github.io/${repoName}/pdf_orari/${bus.file}`, 15, y);
                        doc.setTextColor(0).setFontSize(12).setFont(undefined, 'normal');
                        y += 10;
                    }
                }
                if(y > 270) { doc.addPage(); y = 20; }
            });

            doc.save("Itinerario_Santa_Barbara_ARST.pdf");
        }
    </script>
</body>
</html>
