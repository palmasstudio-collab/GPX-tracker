<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Santa Barbara Planner - Logistica Bus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; margin: 0; height: 100vh; background: #f4f4f4; }
        #map { flex: 3; height: 100%; }
        #sidebar { flex: 1; padding: 20px; background: white; overflow-y: auto; display: flex; flex-direction: column; box-shadow: -2px 0 10px rgba(0,0,0,0.1); }
        .section { margin-bottom: 20px; padding: 15px; background: #f9f9f9; border-radius: 8px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; }
        input[type="date"] { width: 100%; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        .tappa-item { padding: 10px; border: 1px solid #eee; margin-bottom: 5px; cursor: pointer; border-radius: 5px; background: #fff; font-size: 0.85rem; }
        .selezionata { border-left: 5px solid #1a73e8; background: #e8f0fe; font-weight: bold; }
        button { width: 100%; padding: 15px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="sidebar">
        <h2>Planner Cammino ðŸ¥¾</h2>
        
        <div class="section">
            <label>Data di partenza:</label>
            <input type="date" id="data-partenza">
        </div>

        <label>Seleziona tappe nell'ordine:</label>
        <div id="lista-tappe">Caricamento...</div>
        
        <button onclick="generaPDF()">Genera PDF Logistico</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-gpx/1.7.0/gpx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Database semplificato basato sui tuoi 10 PDF
        const arstDb = [
            { id: "840", fermate: ["iglesias", "nebida", "masua"], file: "840.pdf" },
            { id: "853", fermate: ["iglesias", "funtanamare"], file: "853.pdf" },
            { id: "855", fermate: ["iglesias", "plage mesu"], file: "855.pdf" },
            { id: "847", fermate: ["iglesias", "gonnesa", "portoscuso"], file: "847.pdf" },
            { id: "8005", fermate: ["iglesias", "carbonia"], file: "8005.pdf" },
            { id: "841", fermate: ["iglesias", "villacidro", "guspini"], file: "841.pdf" },
            { id: "856", fermate: ["domusnovas", "plage mesu"], file: "856.pdf" }
        ];

        const map = L.map('map').setView([39.2238, 8.5204], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        document.getElementById('data-partenza').valueAsDate = new Date();

        let tappeSelezionate = [];
        let datiGPX = {};
        const repoUser = window.location.hostname.split('.')[0] || "palmasstudio-collab";
        const repoName = "GPX-tracker";

        fetch(`https://api.github.com/repos/${repoUser}/${repoName}/contents/gpx`)
            .then(r => r.json()).then(files => {
                const list = document.getElementById('lista-tappe');
                list.innerHTML = '';
                files.filter(f => f.name.endsWith('.gpx')).forEach(file => {
                    const div = document.createElement('div');
                    div.className = 'tappa-item';
                    div.innerText = file.name.replace('.gpx', '').replace(/-/g, ' ');
                    div.onclick = () => {
                        const idx = tappeSelezionate.indexOf(file.name);
                        if(idx > -1) {
                            tappeSelezionate.splice(idx, 1);
                            div.classList.remove('selezionata');
                            datiGPX[file.name].layer.setStyle({color:'#888', weight:3});
                        } else {
                            tappeSelezionate.push(file.name);
                            div.classList.add('selezionata');
                            datiGPX[file.name].layer.setStyle({color:'#1a73e8', weight:5});
                        }
                    };
                    list.appendChild(div);

                    new L.GPX(file.download_url, {
                        async: true,
                        markers: { startIcon: null, endIcon: null, wpIcon: null }, // Pulisce i marker
                        polyline_options: { color: '#888', opacity: 0.6, weight: 3 }
                    }).on('loaded', e => {
                        datiGPX[file.name] = { 
                            distanza: (e.target.get_distance() / 1000).toFixed(2),
                            layer: e.target
                        };
                    }).addTo(map);
                });
            });

        function getLocalita(filename, tipo) {
            const parti = filename.replace('.gpx', '').split('-');
            if (parti.length < 2) return "";
            return tipo === 'inizio' ? parti[1].toLowerCase() : parti[parti.length - 1].toLowerCase();
        }

        function trovaBus(da, a) {
            return arstDb.find(b => b.fermate.includes(da) && b.fermate.includes(a));
        }

        function generaPDF() {
            const dataInizio = document.getElementById('data-partenza').value;
            if(!dataInizio || tappeSelezionate.length === 0) return alert("Seleziona data e tappe!");
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let y = 20;
            let dataCorrente = new Date(dataInizio);

            doc.setFontSize(16).text("LOGISTICA CAMMINO DI SANTA BARBARA", 10, y);
            y += 15;

            tappeSelezionate.forEach((nome, i) => {
                const d = datiGPX[nome];
                doc.setFontSize(10).setFont(undefined, 'bold').text(`${dataCorrente.toLocaleDateString('it-IT').toUpperCase()} - TAPPA: ${nome}`, 10, y);
                y += 6;
                doc.setFont(undefined, 'normal').text(`Percorso a piedi: ${d.distanza} km`, 10, y);
                y += 12;

                // LOGICA GAP: se la tappa dopo non inizia dove finisce questa
                if(i < tappeSelezionate.length - 1) {
                    const fineAttuale = getLocalita(nome, 'fine');
                    const inizioProssima = getLocalita(tappeSelezionate[i+1], 'inizio');

                    if(fineAttuale && inizioProssima && fineAttuale !== inizioProssima) {
                        const bus = trovaBus(fineAttuale, inizioProssima);
                        doc.setTextColor(0, 0, 255);
                        doc.text(`ðŸšŒ SPOSTAMENTO: Bus linea ${bus ? bus.id : 'da verificare'} tra ${fineAttuale} e ${inizioProssima}`, 15, y);
                        doc.setTextColor(0);
                        y += 10;
                    }
                }
                dataCorrente.setDate(dataCorrente.getDate() + 1);
                if(y > 275) { doc.addPage(); y = 20; }
            });

            // LOGICA RIENTRO AUTO
            y += 10;
            doc.setDrawColor(200, 0, 0).line(10, y, 200, y);
            y += 10;
            doc.setFontSize(12).setFont(undefined, 'bold').text("RIENTRO AL PUNTO DI PARTENZA (RECUPERO AUTO)", 10, y);
            y += 8;

            const puntoAuto = getLocalita(tappeSelezionate[0], 'inizio');
            const puntoArrivo = getLocalita(tappeSelezionate[tappeSelezionate.length - 1], 'fine');
            const busRientro = trovaBus(puntoArrivo, puntoAuto);

            doc.setFont(undefined, 'normal').setFontSize(10);
            doc.text(`Punto partenza (Auto): ${puntoAuto.toUpperCase()}`, 10, y); y += 6;
            doc.text(`Punto arrivo finale: ${puntoArrivo.toUpperCase()}`, 10, y); y += 6;

            if(busRientro) {
                doc.setFont(undefined, 'bold').text(`ðŸšŒ BUS RIENTRO: Linea ${busRientro.id} ARST (Vedi PDF: ${busRientro.file})`, 10, y);
            } else {
                doc.text("ðŸšŒ BUS RIENTRO: Verifica coincidenze via Iglesias Stazione FS", 10, y);
            }

            doc.save("Itinerario_Santa_Barbara.pdf");
        }
    </script>
</body>
</html>
